<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="author" content="João D. Ferreira">
    <meta name="author" content="Francisco M. Couto">
    <title>Processamento de dados de vias metabólicas usando ficheiros, serviços web e bases de dados</title>
    <style type="text/css">code{white-space: pre;}</style>
    <link rel="stylesheet" href="pandoc.css">
    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
</head>
<body>
<header>
<h1 class="title">Processamento de dados de vias metabólicas usando ficheiros, serviços web e bases de dados</h1>
<h2 class="author">João D. Ferreira</h2>
<h2 class="author">Francisco M. Couto</h2>
<h3 class="date">Faculdade de Ciências da Universidade de Lisboa<br>Versão de 2016</h3>
</header>
<div id="license">
<p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> <img src="images/cc-88x31.png" title="Creative Commons License" /> </a> Este documento está protegido pela licença<br> <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons - Atribuição 4.0 Internacional</a></p>
</div>
<h1 id="índice">Índice</h1>
<ul>
<li><a href="#introduction">Introdução</a></li>
<li><a href="#module1">Módulo 1 – Dados de vias metabólicas</a></li>
<li><a href="#module2">Módulo 2 – Seleção simples e guardar informação em disco</a></li>
<li><a href="#module3">Módulo 3 – UniProt como serviço web</a></li>
<li><a href="#module4">Módulo 4 – Cruzamento de dados de várias fontes</a></li>
<li><a href="#module5">Módulo 5 – Seleção de informação com expressões regulares</a></li>
<li><a href="#module6">Módulo 6 – Criar uma base de dados SQL</a></li>
<li><a href="#module7">Módulo 7 – Inserção de dados CSV</a></li>
</ul>
<h1 id="introduction">Introdução</h1>
<p>O objetivo destes exercícios é munir os alunos com a capacidade e a competência para processar dados de forma automática. O tema principal destes exercícios será o processamento de dados de via metabólica, com foco sobre as proteínas que catalisam as reações químicas das vias, também conhecido como <em>enzimas</em>. Apesar de trabalharmos com vias metabólicas durante as aulas, os métodos de processamento de dados que os alunos vão aprender nesta disciplina podem ser aplicado a muitos outros tipos de dados.</p>
<h2 id="dados">Dados</h2>
<p>A figura que se segue representa os primeiros passos na glicólise, uma via metabólica que decompõe a glicose em compostos químicos mais pequenos. Esta figura inclui uma representação de cinco etapas desta via, cada uma catalisada por uma enzima diferente.</p>
<figure>
<img src="images/pathway.png" title="Exemplo de uma via metabólica" alt="Uma via metabólica" /><figcaption>Uma via metabólica</figcaption>
</figure>
<p>Para estas aulas, iremos fornecer <a href="files/metabolic_pathways.xls">um ficheiro Excel</a> com informação sobre 297 vias metabólicas. Cada linha neste arquivo contém:</p>
<ul>
<li>O identificador da via metabólica;</li>
<li>O nome da via;</li>
<li>A classe a que pertence;</li>
<li>Uma lista das enzimas que participam na via.</li>
</ul>
<p>Assim, o arquivo Excel tem 297 linhas de informação, mais uma para os cabeçalhos das colunas.</p>
<p>A imagem seguinte mostra uma imagem do ficheiro Excel e seus dados.</p>
<figure>
<img src="images/excel.png" title="Parte dos dados do ficheiro Excel" alt="Screenshot do ficheiro Excel" /><figcaption>Screenshot do ficheiro Excel</figcaption>
</figure>
<p>Esta informação foi extraída de um banco de dados online chamado <a href="http://www.genome.jp/kegg/kegg2.html">Kyoto Encyclopedia of Genes and Genome</a>. As enzimas são referidos pelo seu código UniProt. A <a href="http://www.uniprot.org/">UniProt</a> é um banco de dados de proteínas que contêm, entre uma vasta quantidade de informação, as sequências de aminoácidos das proteínas.</p>
<h2 id="processamento">Processamento</h2>
<p>Apesar de os dados serem fornecidos aos alunos na forma de ficheiro Excel, as operações de processamento de dados vão ser maioritariamente executadas com uma linguagem de programação. Nesta disciplina vamos usar <a href="http://www.python.org">Python</a>. O processamento dos dados com Python em vez de Excel oferece vários benefícios:</p>
<ul>
<li>Podemos definir um conjunto de operações a serem executadas automaticamente, as quais levariam muito tempo no Excel, uma vez que nesse programa o processamento de dados é feito maioritariamente através da interação do utilizador com a interface gráfica, e não com o uso direto de comandos;</li>
<li>Uma linguagens de programação pode lidar com tipos de dados complexos, enquanto que o Excel é principalmente orientada para cálculos numéricos.</li>
</ul>
<p>Não será necessário nenhum conhecimento profundo da programação para os exercícios das aulas, pois iremos fornecer a maior parte do código. Na verdade, os alunos não aprenderão diretamente os detalhes do Python como uma linguagem de programação, mas em vez disso, serão dadas “receitas” que contêm a maior parte da lógica necessária, com pequenos trechos de código em falta que os estudantes precisarão de preencher. No entanto, esperamos que os alunos se familiarizarem com a sintaxe de Python, seguindo alguns cursos online. Por exemplo, o <a href="https://www.codecademy.com/en/tracks/python">Codecademy</a> contém seis módulos que irão ajudar os alunos nesta tarefa (note-se que existem versões em português nesse site):</p>
<ul>
<li><a href="https://www.codecademy.com/courses/introduction-to-python-6WeG3/0/1?curriculum_id=4f89dab3d788890003000096">Python Syntax</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-sRXwR/0/1?curriculum_id=4f89dab3d788890003000096">Strings &amp; Console Output</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-BxUFN/0/1?curriculum_id=4f89dab3d788890003000096">Conditionals &amp; Control Flow</a></li>
<li><a href="https://www.codecademy.com/courses/python-beginner-en-pwmb1/0/1?curriculum_id=4f89dab3d788890003000096">Python Lists and Dictionaries</a></li>
<li><a href="https://www.codecademy.com/courses/python-intermediate-en-OGNHh/0/1?curriculum_id=4f89dab3d788890003000096">File Input/Output</a></li>
</ul>
<h1 id="module1">Módulo 1 – Dados de vias metabólicas</h1>
<h2 id="parte-i-notepad-e-python">Parte I: Notepad++ e Python</h2>
<h3 id="objetivos">Objetivos:</h3>
<ul>
<li>Abrir o Notepad++, escrever algum código Python e gravar o ficheiro</li>
<li>Executar o código com o interpretador Python</li>
</ul>
<h3 id="passos">Passos:</h3>
<ol type="1">
<li>No menu iniciar do Windows, abra o <code>Notepad++</code>.</li>
</ol>
<figure>
<img src="images/open-notepad.png" title="Abrir o Notepad++" alt="Abrir o Notepad++" /><figcaption>Abrir o Notepad++</figcaption>
</figure>
<ol start="2" type="1">
<li>Escreva um pequeno programa “Hello World” e grave o ficheiro no Ambiente de Trabalho (ou em qualquer outra pasta que quiser) com o nome <code>test.py</code>.</li>
</ol>
<figure>
<img src="images/hello-world.png" title="O programa &quot;Hello World&quot;" alt="O programa &quot;Hello World&quot;" /><figcaption>O programa &quot;Hello World&quot;</figcaption>
</figure>
<ol start="3" type="1">
<li>No menu iniciar, abra a linha de comandos (<code>cmd</code>).</li>
</ol>
<figure>
<img src="images/open-cmd.png" title="Abrindo a linha de comandos" alt="Abrindo a linha de comandos" /><figcaption>Abrindo a linha de comandos</figcaption>
</figure>
<ol start="4" type="1">
<li><p>No terminal (a janela com a linha de comandos), precisamos de navegar para o Ambiente de Trabalho e depois instruir o interpretador Python a executar o ficheiro <code>test.py</code>. Para tal, escreva e execute os seguintes comandos no terminal:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> Desktop
<span class="kw">python</span> test.py</code></pre></div>
<figure>
<img src="images/hello-world-run.png" title="O output do programa &quot;Hello World&quot;" alt="O output do programa &quot;Hello World&quot;" /><figcaption>O output do programa &quot;Hello World&quot;</figcaption>
</figure></li>
<li><p>Observe o output produzido pelo Python e confirme que o terminal mostra o seguinte:</p>
<pre class="text"><code>Hello World!</code></pre></li>
</ol>
<h2 id="part-ii-iniciando-o-processamento-de-dados">Part II: Iniciando o processamento de dados</h2>
<h3 id="objetivos-1">Objetivos:</h3>
<ul>
<li>Compreender o formato CSV</li>
<li>Converter um ficheiro Excel no formato CSV</li>
<li>Compreender o significado de metadados</li>
<li>Ler ficheiros CSV com Python</li>
</ul>
<h3 id="input">Input:</h3>
<ul>
<li>Ficheiro: <a href="files/metabolic_pathways.xls">metabolic_pathways.xls</a></li>
</ul>
<h3 id="output">Output:</h3>
<ul>
<li>Ficheiro: <code>metabolic_pathways.csv</code></li>
<li><p>Terminal:</p>
<pre class="text"><code>Glycolysis / Gluconeogenesis
Citrate cycle (TCA cycle)
Pentose phosphate pathway
Pentose and glucuronate interconversions
...</code></pre></li>
</ul>
<h3 id="passos-1">Passos:</h3>
<ol type="1">
<li><p>Abra o ficheiro Excel. Tome especial atenção ao conteúdo deste ficheiro e familiarize-se com os dados que contém. Este passo é de grande importância em processamento de dados, pois permite-nos ganhar intuição sobre a informação com que estamos a lidar.</p></li>
<li><p>Remova a primeira linha, que contém os cabeçalhos das colunas. (Esta primeira linha é classificada como “metadados” uma vez que fornece informação acerca dos dados no ficheiro mas não contém, por si mesma, dados.)</p></li>
<li><p>Usando as funcionalidades do Excel, grave os dados no formato CSV usando o nome <code>metabolic_pathways.csv</code>.</p></li>
<li><p>Abra o ficheiro CSV num editor de texto (<code>Notepad++</code>) e estude o conteúdo do novo ficheiro. Por exemplo, determine qual caracter é usado para separar os vários campos, se os campos estão delimitados e como, <em>etc</em>.</p></li>
<li><p>Vamos criar um <em>script</em> Python para ler o ficheiro CSV e imprimir o nome de cada via.</p>
<ol type="a">
<li><p>Crie um ficheiro vazio e grave-o como <code>module1.py</code> na mesma pasta onde está o ficheiro <code>metabolic_pathways.csv</code>. Não esqueça a terminação <code>.py</code>, pois esta indica ao computador que o ficheiro é um <em>script</em> Python.</p></li>
<li><p>Copie e cole o código seguinte para o seu ficheiro:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;metabolic_pathways.csv&#39;</span>) <span class="co"># Abre o ficheiro</span>

paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???) <span class="co"># Cria um leitor de CSV</span>

<span class="cf">for</span> path <span class="op">in</span> paths: <span class="co"># Para cada via ...</span>
    <span class="bu">print</span> ???      <span class="co"># ... imprime o seu nome</span></code></pre></div></li>
<li><p>Substitua todos os pontos de interrogação (<code>???</code>) por código Python apropriado.</p></li>
</ol></li>
<li><p>Corra o <code>module1.py</code> no terminal e observe o output. O output corresponde ao que estava à espera de ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>metabolic_pathways.csv</code> para si, assim como do <em>script</em> <code>module1.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula">Após a aula:</h2>
<ol type="1">
<li><p>Altere o código Python para imprimir não o nome das vias mas a sua classe.</p></li>
<li><p>Explique a razão pela qual alguns campos no ficheiro CSV estão delimitados por aspas <nobr>(<code>&quot;</code>)</nobr> e outros não.</p></li>
</ol>
<h1 id="module2">Módulo 2 – Seleção simples e guardar informação em disco</h1>
<h2 id="objetivos-2">Objetivos:</h2>
<ul>
<li>Transformar um critério de seleção em código Python</li>
<li>Implementar o processo de seleção em Python</li>
<li>Gravar os dados selecionados num novo ficheiro</li>
</ul>
<h2 id="input-1">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/metabolic_pathways.csv">metabolic_pathways.csv</a></li>
</ul>
<h2 id="output-1">Output:</h2>
<ul>
<li>Ficheiro: <code>selected1.csv</code>
<ul>
<li>contendo os dados da via <code>hsa04210</code>.</li>
</ul></li>
<li>Ficheiro: <code>selected2.csv</code>
<ul>
<li>contendo os dados das vias <code>hsa00730</code> e <code>hsa04122</code>.</li>
</ul></li>
</ul>
<h2 id="passos-2">Passos:</h2>
<ol type="1">
<li><p>Vamos criar uma função Python que determine se o ID de uma via é <code>hsa04210</code>:</p>
<ol type="a">
<li><p>Crie um ficheiro vazio e grave-o como <code>module2.py</code> na mesma pasta onde o ficheiro <code>metabolic_pathways.csv</code> está. Não se esqueça da terminação <code>.py</code>, pois esta indica ao computador que o ficheiro é um <em>script</em> Python.</p></li>
<li><p>Copie e cole o código seguinte para o ficheiro:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> filter1(path):
    path_id <span class="op">=</span> path[???]  <span class="co"># Seleciona a coluna do identificar</span>

    <span class="co"># Substitua &#39;???&#39; pelo identificador que estamos a procura</span>
    <span class="cf">if</span> path_id <span class="op">==</span> <span class="st">&#39;???&#39;</span>:
        <span class="cf">return</span> <span class="va">True</span>
    <span class="cf">else</span>:
        <span class="cf">return</span> <span class="va">False</span></code></pre></div></li>
<li><p>Substitua os pontos de interrogração (<code>???</code>) por código Python apropriado.</p></li>
</ol></li>
<li><p>O código do passo anterior define uma função que vai ser executada quando for chamada, mas por si só não faz nada. Vamos adicionar mais código ao ficheiro para efetivamente usarmos a função em cada uma das vias metabólicas.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Abre o ficheiro original para ler todas as vias</span>
file_to_read <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;metabolic_pathways.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(file_to_read, delimiter<span class="op">=</span>???)

<span class="co"># Abre o ficheiro para gravar as vias selecionadas</span>
<span class="co"># O &#39;wb&#39; indica ao Python que queremos gravar neste ficheiro</span>
file_to_write <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected1.csv&#39;</span>, <span class="st">&#39;wb&#39;</span>)
w <span class="op">=</span> csv.writer(file_to_write, delimiter<span class="op">=</span>???)

<span class="cf">for</span> path <span class="op">in</span> paths:
    <span class="cf">if</span> filter1(path):
        w.writerow(path)

<span class="co"># Fecha o ficheiro</span>
file_to_write.close()</code></pre></div></li>
<li><p>Corra o <em>script</em> <code>module2.py</code> e estude o novo ficheiro que foi criado. Verifique que o seu conteúdo corresponde ao que esperava.</p></li>
<li><p>Edite o ficheiro <code>module2.py</code> criando agora uma nova função <code>filter2</code> que seleciona as vias onde a enzima Q9Y697 participa. Se necessário, consulte a documentação para a função <code>str.split</code> em <a href="https://docs.python.org/2/library/stdtypes.html#str.split" class="uri">https://docs.python.org/2/library/stdtypes.html#str.split</a>. Vamos implementar esta funcionalidade em dois passos:</p>
<ol type="a">
<li><p>Crie a nova função <code>filter2</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> filter2(path):
    field <span class="op">=</span> path[???] <span class="co"># Seleciona a coluna com a lista de enzymas</span>

    <span class="co"># Divide as enzimas numa lista</span>
    enzyme_list <span class="op">=</span> <span class="bu">str</span>.split(field, ???)

    <span class="co"># `enzyme_list` e agora uma lista de strings, como por exemplo:</span>
    <span class="co"># [&#39;H9EC08&#39;, &#39;P03905&#39;, &#39;G9LG04&#39;, &#39;P03901&#39;]</span>

    <span class="co"># Devolve `True` se a enzima escolhida estiver nessa lista</span>
    <span class="cf">if</span> <span class="st">&#39;???&#39;</span> <span class="op">in</span> enzyme_list:
        <span class="cf">return</span> <span class="va">True</span>
    <span class="cf">else</span>:
        <span class="cf">return</span> <span class="va">False</span></code></pre></div></li>
<li><p>Altere <code>'selected1.csv'</code> para <code>'selected2.csv'</code>. Esta modifação é essencial para que o novo ficheiro produzido não substitua o que já existe.</p></li>
</ol></li>
<li><p>Corra o <code>module2.py</code> outra vez e estude o ficheiro que foi produzido. Verifique que o seu conteúdo corresponde ao que esperava: em particular, assegure-se que a enzima Q9Y697 pertence a todas as vias selecionadas.</p></li>
<li><p>Certifique-se de que mantém uma cópia dos ficheiros <code>selected1.csv</code> e <code>selected2.csv</code> para si, assim como do <em>script</em> <code>module2.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-1">Após a aula:</h2>
<ol type="1">
<li><p>Crie uma terceira função <code>filter3</code> que seleciona as vias que fazem parte da classe “Human Diseases; Cancers”.</p></li>
<li><p>Usando a função pré-existente <code>len</code>, que devolve o número de elementos numa lista, crie a função <code>filter4</code> que seleciona as vias que contêm no máximo 10 enzimas. A documentação para esta função pode ser encontrada em <a href="https://docs.python.org/2/library/functions.html#len" class="uri">https://docs.python.org/2/library/functions.html#len</a></p></li>
</ol>
<p><strong>Nota</strong>: para ler e escrever ficheiros CSV em Python, usámos (e vamos usar mais vezes) o módulo <code>csv</code>. Este módulo permite especificar o formato do ficheiro a ler e escrever, <em>e.g.</em> qual o caracter a usar para separar os campos e para os delimitar. Deve familiarizar-se com este módulo por si mesmo lendo a documentação em <a href="https://docs.python.org/2/library/csv.html" class="uri">https://docs.python.org/2/library/csv.html</a>.</p>
<h1 id="module3">Módulo 3 – UniProt como serviço web</h1>
<h2 id="objetivos-3">Objetivos:</h2>
<ul>
<li>Reconhecer a importância das fontes de dados externas</li>
<li>Usar um serviço web através de código Python</li>
<li>Processar a informação proveniente de um serviço web</li>
</ul>
<h2 id="input-2">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/selected2.csv">selected2.csv</a>
<ul>
<li>criado no módulo anterior</li>
</ul></li>
</ul>
<h2 id="output-2">Output:</h2>
<ul>
<li>Ficheiro: <code>sequences.csv</code>
<ul>
<li>contendo as sequências de aminoácidos de cada enzima</li>
</ul></li>
</ul>
<h2 id="passos-3">Passos:</h2>
<ol type="1">
<li><p>Abra o URL <a href="http://www.uniprot.org/uniprot/P12345.fasta" class="uri">http://www.uniprot.org/uniprot/P12345.fasta</a> no <em>browser</em> e estude o formato FASTA. Altere o identificador do link de <code>P12345</code> para outro à sua escolha e estude o seu conteúdo e quais as diferenças entre os dois.</p></li>
<li><p>Num <em>script</em> Python chamado <code>module3.py</code>, crie uma função chamada <code>get_sequence</code> que recebe o identificador de uma proteína e devolve a sua sequência de aminoácidos. Esta função:</p>
<ol type="a">
<li><p>abre o URL mencionado acima,</p></li>
<li><p>lê o conteúdo acessível por esse URL,</p></li>
<li><p>extrai a sequência de aminoácidos, e</p></li>
<li><p>junta todas as linhas numa só, de forma a devolver apenas uma <em>string</em>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> urllib <span class="co"># Este modulo contem funcoes para ler URLs</span>

<span class="kw">def</span> get_sequence(identifier):
    <span class="co"># Estabelece o URL a abrir</span>
    url <span class="op">=</span> <span class="st">&#39;http://www.uniprot.org/uniprot/&#39;</span> <span class="op">+</span> ??? <span class="op">+</span> <span class="st">&#39;.fasta&#39;</span>

    <span class="co"># Abre o URL</span>
    f <span class="op">=</span> urllib.urlopen(url)

    <span class="co"># Le todas as linhas do URL  numa lista</span>
    lines <span class="op">=</span> f.readlines()

    <span class="co"># Ignora a primeira linha, que contem apenas metadados</span>
    <span class="kw">del</span> lines[<span class="dv">0</span>]

    <span class="co"># Junta as linhas todas numa string unica</span>
    sequence <span class="op">=</span> <span class="bu">str</span>.join(<span class="st">&quot;&quot;</span>, lines)

    <span class="co"># Remove a terminacao das linhas (o &quot;enter&quot; usado para comecar</span>
    <span class="co"># a linha seguinte)</span>
    <span class="co"># Esta terminacao e representada por `\n`</span>
    sequence <span class="op">=</span> <span class="bu">str</span>.replace(sequence, <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39;&#39;</span>)

    <span class="co"># Devolve a sequencia</span>
    <span class="cf">return</span> ???</code></pre></div></li>
</ol></li>
<li><p>Vamos experimentar executar a função com um pequeno número de proteínas. Para tal, adicione as seguintes linhas ao <em>script</em> Python, substituindo <code>???</code> pelos identificadores que quiser:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">sequence1 <span class="op">=</span> get_sequence(<span class="st">&#39;P12345&#39;</span>)
sequence2 <span class="op">=</span> get_sequence(<span class="st">&#39;???&#39;</span>)
sequence3 <span class="op">=</span> get_sequence(<span class="st">&#39;???&#39;</span>)

<span class="bu">print</span> <span class="st">&quot;SEQUENCE 1:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence1 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
<span class="bu">print</span> <span class="st">&quot;SEQUENCE 2:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence2 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
<span class="bu">print</span> <span class="st">&quot;SEQUENCE 3:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> sequence3 <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span></code></pre></div></li>
<li><p>Agora que já vimos como utilizar a função, vamos ler as enzimas do ficheiro <code>selected2.csv</code> e determinar as suas sequências de aminoácidos.</p>
<ol type="a">
<li><p>Remova ou comente as linhas do passo 3.</p></li>
<li><p>Substitua-as por:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Abre o output do modulo anterior</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected2.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Comeca uma lista de enzimas vazia</span>
enzymes <span class="op">=</span> []

<span class="co"># Depois:</span>
<span class="co"># - le a informacao de cada via,</span>
<span class="co"># - extrai a lista de enzimas de cada via, e</span>
<span class="co"># - adiciona cada enzima a lista de enzimas</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    enzymes_field <span class="op">=</span> path[???] <span class="co"># O campo das enzimas</span>

    <span class="co"># Divide as enzimas numa lista, tal como no modulo 2</span>
    enzymes_in_this_path <span class="op">=</span> <span class="bu">str</span>.split(enzymes_field, ???)

    <span class="co"># Adiciona cada uma a lista mestre de enzimas</span>
    <span class="cf">for</span> e <span class="op">in</span> enzymes_in_this_path:
        enzymes.append(e)</code></pre></div></li>
</ol></li>
<li><p>Agora que temos uma lista de enzimas, podemos usá-la juntamente com a função que criamos anteriormente para obter as suas sequências de aminoácidos. Vamos gravar esta informação num novo ficheiro <code>sequences.csv</code>. Para tal, continue a adicionar códugo ao <em>script</em> <code>module3.py</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>, <span class="st">&#39;wb&#39;</span>)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

<span class="cf">for</span> e <span class="op">in</span> enzymes:
    seq <span class="op">=</span> get_sequence(e)
    w.writerow([e, seq])

f.close()</code></pre></div></li>
<li><p>Execute o código e estude o conteúdo do novo ficheiro (<code>sequences.csv</code>). Corresponde ao que esperava ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>sequences.csv</code> para si, assim como do <em>script</em> <code>module3.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-2">Após a aula:</h2>
<ol type="1">
<li><p>Verifique que no ficheiro <code>sequences.csv</code> algumas enzimas aparecem repetidas. Tente explicar porquê.</p></li>
<li><p>Altere o código de forma a encontrar a sequência de aminoácidos de todas as enzimas das vias metabólicas, e não apenas das enzimas nas vias selecionadas no módulo anterior. Grave as sequências num ficheiro chamado <code>all_sequences.csv</code>.</p></li>
</ol>
<h1 id="module4">Módulo 4 – Cruzamento de dados de várias fontes</h1>
<h2 id="objetivos-4">Objetivos:</h2>
<ul>
<li>Usar dicionários para associar informação</li>
<li>Cruzar dados de diversas fontes</li>
</ul>
<h2 id="input-3">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/selected2.csv">selected2.csv</a>
<ul>
<li>criado no módulo 2</li>
</ul></li>
<li>Ficheiro: <a href="files/sequences.csv">sequences.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
</ul>
<h2 id="output-3">Output:</h2>
<ul>
<li>Ficheiro: <code>paths_enzymes.csv</code></li>
</ul>
<h2 id="passos-4">Passos:</h2>
<ol type="1">
<li><p>Comece por criar um novo <em>script</em> <code>module4.py</code> vazio.</p></li>
<li><p>Vamos primeiro ler o ficheiro <code>sequences.csv</code> para construir um dicionário onde cada enzima é associada à sua própria sequência. Para tal, adicione ao <em>script</em> o seguinte código, substituindo os pontos de interrogação:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Le o ficheiro CSV</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Cria um dicionario vazio onde vamos introduzir a informacao</span>
<span class="co"># proveniente do ficheiro CSV</span>
dict_sequences <span class="op">=</span> {}

<span class="co"># Para cada enzima no ficheiro, associa-a com a sua sequencia</span>
<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> enzyme[???] <span class="co"># O identificador desta enzima</span>
    seq <span class="op">=</span> enzyme[???]       <span class="co"># A sequencia de aminoacidos da enzima</span>
    dict_sequences[enzyme_id] <span class="op">=</span> seq</code></pre></div></li>
<li><p>Em seguida, vamos ler o ficheiro <code>selected2.csv</code> e associar a cada via uma lista das suas enzimas Também aqui vamos usar um dicionário.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Le o ficheiro CSV</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;selected2.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Cria um dicionario vazio onde vamos introduzir a informacao</span>
<span class="co"># proveniente do ficheiro CSV</span>
dict_paths <span class="op">=</span> {}

<span class="co"># Para cada via nesse ficheiro:</span>
<span class="co"># - extrai a lista de enzimas da via,</span>
<span class="co"># - associa a via com esta lista de enzimas</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    path_id <span class="op">=</span> path[???] <span class="co"># O identificador da via</span>
    enzymes <span class="op">=</span> path[???] <span class="co"># O campo com a lista de enzimas</span>

    <span class="co"># Divide a string de enzimas numa lista</span>
    enzyme_list <span class="op">=</span> <span class="bu">str</span>.split(enzymes, ???)

    <span class="co"># Associa o identificador da via com a lista de enzimas</span>
    dict_paths[???] <span class="op">=</span> ???</code></pre></div></li>
<li><p>Agora que temos os dois dicionários, podemos percorrer cada via e cada enzima de cada via de forma a criar um ficheiro CSV que cruza a informação, associando a cada via as sequências de aminoácidos das suas enzimas. Para tal, adicione o seguinte ao seu <em>script</em>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Abre um ficheiro para gravar o output</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;paths_enzymes.csv&#39;</span>, <span class="st">&#39;wb&#39;</span>)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

<span class="co"># Para cada via e cada enzima que ela contem</span>
<span class="cf">for</span> path_id <span class="op">in</span> dict_paths :
    <span class="co"># Vamos imprimir alguma informacao no ecra para</span>
    <span class="co"># sabermos o que esta a acontecer</span>
    <span class="bu">print</span> <span class="st">&#39;Processing pathway with ID &#39;</span> <span class="op">+</span> path_id

    <span class="co"># Seleciona a lista de enzimas associadas a esta via</span>
    enzyme_list <span class="op">=</span> dict_paths[???]

    <span class="co"># Agora que temos a lista de enzimas, associa a via com a cada uma</span>
    <span class="co"># das sequencias de aminoacidos das suas enzimas</span>
    <span class="cf">for</span> enzyme_id <span class="op">in</span> enzyme_list:
        <span class="co"># Mais informacao de depuracao</span>
        <span class="bu">print</span> <span class="st">&#39;  enzyme = &#39;</span> <span class="op">+</span> enzyme_id

        <span class="co"># Seleciona a sequencia associada a esta enzima</span>
        seq <span class="op">=</span> dict_sequences[???]

        <span class="co"># Escreve esta informacao no ficheiro CSV</span>
        w.writerow([path_id, seq])

f.close()</code></pre></div></li>
<li><p>Corra o código e estude o conteúdo do ficheiro que foi criado (<code>paths_enzymes.csv</code>). Corresponde ao que estava à espera?</p></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>paths_enzymes.csv</code> para si, assim como do <em>script</em> <code>module4.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-3">Após a aula:</h2>
<ol type="1">
<li>Altere o critério de seleção usado para criar o ficheiro <code>selected2.csv</code> (por exemplo selecionando as vias com um máximo de 10 enzimas, como proposto no módulo 2). Em seguida altere o código de hoje para acomodar esta alteração.</li>
</ol>
<h1 id="module5">Módulo 5 – Seleção de informação com expressões regulares</h1>
<h2 id="objetivos-5">Objetivos:</h2>
<ul>
<li>Desenhar expressões regular para representar vários critérios de seleção</li>
<li>Usar o módulo <code>re</code> para criar e utilizar expressões regular</li>
<li>Procurar por motivos de aminoácidos nas sequências das enzimas</li>
</ul>
<h2 id="input-4">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/sequences.csv">sequences.csv</a>
<ul>
<li>criado no módulo 3</li>
</ul></li>
</ul>
<h2 id="output-4">Output:</h2>
<ul>
<li>Ficheiro: <code>relevant_sequences_1.csv</code></li>
<li>Ficheiro: <code>relevant_sequences_2.csv</code></li>
<li>Ficheiro: <code>relevant_sequences_3.csv</code></li>
</ul>
<h2 id="passos-5">Passos:</h2>
<ol type="1">
<li><p>Neste módulo, vamos usar expressões regulares para procurar enzimas cujas sequências de aminoácidos satisfazem certos padrões.</p>
<ol type="a">
<li><p>Consulte a <a href="http://www.cheat-sheets.org/saved-copy/regular_expressions_cheat_sheet.png">folha de mnemónicas de expressões regulares</a>.</p></li>
<li><p>Pode ainda encontrar a correspondência entre cada aminoácido e a seu código de 1 letra <a href="http://bio100.class.uic.edu/lectures/aminoacids01.jpg">neste quadro</a>.</p></li>
<li><p>Familiarize-se com estes dois quadros.</p></li>
</ol></li>
<li><p>Começamos por ler o conteúdo do ficheiro <code>sequences.csv</code> e por criar um dicionário que associa as enzimas às suas sequências de aminoácidos, tal como fizemos no módulo anterior. Crie o <em>script</em> <code>module5.py</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Le o ficheiro CSV</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Cria um dicionario vazio onde vamos introduzir a informacao</span>
<span class="co"># proveniente do ficheiro CSV</span>
dict_sequences <span class="op">=</span> {}

<span class="co"># Para cada enzima no ficheiro, associa-a com a sua sequencia</span>
<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> enzyme[???] <span class="co"># O identificador desta enzima</span>
    seq <span class="op">=</span> enzyme[???]       <span class="co"># A sequencia de aminoacidos da enzima</span>
    dict_sequences[enzyme_id] <span class="op">=</span> seq</code></pre></div></li>
<li><p>Agora que temos o dicionário, vamos procurar as enzimas cujas sequências contêm três alaninas consecutivas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Importamos o modulo `re` para lidar com expressoes regulares</span>
<span class="im">import</span> re

<span class="co"># Defina aqui a sua expressao regular</span>
reg_expr <span class="op">=</span> <span class="vs">r&#39;???&#39;</span>

<span class="co"># Para cada enzima, obtem a sua sequencia e determina se a sequencia</span>
<span class="co"># satisfaz o padrao: tres alaninas consecutivas</span>
<span class="cf">for</span> enzyme <span class="op">in</span> dict_sequences:
    <span class="co"># Seleciona a sequencia de aminoacidos</span>
    seq <span class="op">=</span> ???

    <span class="co"># Determina se a sequencia satisfaz o padrao</span>
    <span class="cf">if</span> re.search(reg_expr, seq):
        <span class="bu">print</span> <span class="st">&#39;The enzyme &#39;</span> <span class="op">+</span> ??? <span class="op">+</span> <span class="st">&#39; matches the expression &#39;</span> <span class="op">+</span> reg_expr</code></pre></div></li>
<li><p>Modifique o código acima para gravar os identificadores e sequências de aminoácidos num ficheiro <code>relevant_sequences_1.csv</code>, em vez de escrever no ecrã. Refira-se ao módulo 3, passo 5 se necessitar de se relembrar de como escrever um ficheiro CSV.</p></li>
<li><p>Altere a expressão regular no <em>script</em> para encontrar outros padrões. Para cada um destes padrões, grave os identificadores e sequências no ficheiro <code>relevant_sequences_2.csv</code> e <code>relevant_sequences_3.csv</code> respetivamente.</p>
<ol type="a">
<li><p>Sequências onde os primeiros 5 aminoácidos são não-polares.</p></li>
<li><p>Sequências que contêm uma metionina, seguida de qualquer aminoácido, seguida de uma serina ou uma prolina.</p></li>
</ol></li>
<li><p>Execute o código e estude os ficheiros criados. Correspondem ao que esperava ver?</p></li>
<li><p>Certifique-se de que mantém uma cópia dos ficheiros <code>relevant_sequences_1.csv</code>, <code>relevant_sequences_2.csv</code> e <code>relevant_sequences_3.csv</code> para si, assim como do <em>script</em> <code>module5.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-4">Após a aula:</h2>
<ol type="1">
<li><p>Escreva uma expressão regular alternativa à definida no passo 1, mantendo o significado mas usando elementos de expressões regulares diferentes.</p></li>
<li><p>Imagine que quer aplicar a primeira expressão regular usada neste módulo (3 alaninas consecutivas) ao ficheiro <code>relevant_sequences_2.csv</code> em vez de <code>sequences.csv</code>. Altere o <em>script</em> Python para acomodar estas alterações. Verifique se o resultado é igual ao que tinha obtido no ficheiro <code>relevant_sequences_1.csv</code>.</p></li>
</ol>
<p><strong>Nota</strong>: Para os alunos que queiram explorar expressões regulares em mais detalhe, propomos o seguinte exercício:<br> Qual a expressão regular que descreve um grupo de ligação ao GTP? Este é um grupo complexo que consiste em três sub-sequências:</p>
<ul>
<li>a primeira é <code>GXXXXGK</code>,</li>
<li>a segunda é <code>DXXG</code>, e</li>
<li>a terceira é <code>NKXD</code> ou <code>NKXW</code>.</li>
</ul>
<p>Entre o primeiro e o segundo grupos existem 40 a 80 aminoácidos ou 130 a 170 aminoácidos; entre o segundo e o terceiro grupo existem entre 40 a 80 aminoácidos. <small>[Fonte: Dever TE, Glynias MJ, Merrick WC (1987). PNAS 84(7), 1814-1818.]</small></p>
<h1 id="module6">Módulo 6 – Criar uma base de dados SQL</h1>
<h2 id="objetivos-6">Objetivos:</h2>
<ul>
<li>Desenhar um esquema de base de dados simples para guardar informação de vias metabólicas</li>
<li>Usar chaves estrangeiras</li>
</ul>
<h2 id="input-5">Input:</h2>
<ul>
<li>Nenhum</li>
</ul>
<h2 id="output-5">Output:</h2>
<ul>
<li>Ficheiro de base de dados: <code>pathways.db</code></li>
</ul>
<h2 id="passos-6">Passos:</h2>
<ol type="1">
<li><p>Vamos começar por criar uma nova base de dados vazia no ficheiro <code>pathways.db</code> com três tabelas. Primeiro, crie um <em>script</em> <code>module6.py</code> com o seguinte código:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># `sqlite3` e um modulo usado para criar bases de dados relacionais.</span>
<span class="co"># Usamos este modulo para criar a base de dados, e para inserir e</span>
<span class="co"># consultar os dados</span>

<span class="im">import</span> sqlite3

<span class="co"># Para aceder a base de dados, precisamos de estabelecer uma ligacao</span>
<span class="co"># com ela. Se o ficheiro nao existir, vai ser criado vazio.</span>
connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;pathways.db&#39;</span>)</code></pre></div></li>
<li><p>Agora que temos uma base de dados vazia, vamos adicionar as tabelas necessárias para guardar os dados de vias metabólicas.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Apaga as tabelas caso ja existam na base de dados</span>
connection.execute(<span class="st">&#39;DROP TABLE IF EXISTS path&#39;</span>)
connection.execute(<span class="st">&#39;DROP TABLE IF EXISTS enzyme&#39;</span>)
connection.execute(<span class="st">&#39;DROP TABLE IF EXISTS path_enzyme&#39;</span>)

<span class="co"># Esta tabela vai conter dados de vias metabolicas</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE path (</span>
<span class="st">        id VARCHAR(255) PRIMARY KEY,</span>
<span class="st">        name VARCHAR(255) NOT NULL,</span>
<span class="st">        class VARCHAR(255) NOT NULL</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># Esta tabela vai conter dados das enzimas</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE enzyme (</span>
<span class="st">        id VARCHAR(255) PRIMARY KEY,</span>
<span class="st">        sequence TEXT NOT NULL</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># Esta tabela vai associar cada via com as suas enzimas</span>
connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    CREATE TABLE path_enzyme (</span>
<span class="st">        path_id VARCHAR(255),</span>
<span class="st">        enzyme_id VARCHAR(255),</span>
<span class="st">        PRIMARY KEY (path_id, enzyme_id),</span>
<span class="st">        FOREIGN KEY (path_id) REFERENCES path (id),</span>
<span class="st">        FOREIGN KEY (enzyme_id) REFERENCES enzyme (id)</span>
<span class="st">    )</span>
<span class="st">&#39;&#39;&#39;</span>)</code></pre></div></li>
<li><p>Uma vez criadas as tabelas, podemos inserir os dados. Como exemplo, vamos inserir apenas uma via e duas enzimas dessa via. Se necessário, consulte os ficheiros criados nos módulos anteriores para encontrar o nome da via <code>hsa00730</code> e as enzimas que fazem parte dela.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path (id, name, class)</span>
<span class="st">    VALUES (&#39;hsa00730&#39;, &#39;???&#39;, &#39;???&#39;)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO enzyme (id, sequence)</span>
<span class="st">    VALUES (&#39;Q53FP3&#39;,&#39;???&#39;)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO enzyme (id, sequence)</span>
<span class="st">    VALUES (&#39;???&#39;,&#39;???&#39;)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">    VALUES (&#39;hsa00730&#39;,&#39;???&#39;)</span>
<span class="st">&#39;&#39;&#39;</span>)

connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">    INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">    VALUES (&#39;???&#39;,&#39;???&#39;)</span>
<span class="st">&#39;&#39;&#39;</span>)

<span class="co"># Grava a base de dados</span>
connection.commit()</code></pre></div></li>
<li><p>Por fim, vamos assegurar-nos que as tabelas contêm os dados que lá colocámos. Para isso pode usar o <a href="http://sqlitebrowser.org/">DB Browser for SQLite</a>, cuja versão <a href="https://github.com/sqlitebrowser/sqlitebrowser/releases/download/v3.9.1/SQLiteDatabaseBrowserPortable_3.9.1_English.paf.exe">“portable”</a> pode ser usada sem necessitar de instalação. Para verificar pelo python, podemos selecionar por exemplo as enzimas de cada via.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT id, sequence FROM enzyme&#39;</span>)
<span class="cf">for</span> row <span class="op">in</span> rows:
    enzyme_id <span class="op">=</span> row[<span class="dv">0</span>]
    enzyme_sequence <span class="op">=</span> row[<span class="dv">1</span>]

    <span class="bu">print</span> enzyme_id <span class="op">+</span> <span class="st">&#39; starts with &#39;</span> <span class="op">+</span> enzyme_sequence[:<span class="dv">5</span>]</code></pre></div></li>
<li><p>Verifique que o output corresponde ao seguinte:</p>
<pre class="text"><code>Q53FP3 starts with MLLRA
Q9Y697 starts with MLLRA</code></pre></li>
<li><p>Certifique-se de que mantém uma cópia do ficheiro <code>pathways.db</code> para si, assim como do <em>script</em> <code>module6.py</code>, de forma a que os possa usar nos próximos módulos. Por exemplo, envie-os para si por email ou faça o upload para a Dropbox.</p></li>
</ol>
<h2 id="após-a-aula-5">Após a aula:</h2>
<ol type="1">
<li><p>Verifique a razão pela qual a chave primária da tabela path_enzyme tem dois atributos.</p></li>
<li><p>Modifique o esquema da base de dados para que possa guardar também o nome de cada enzima e a sua posição na via metabólica (um número inteiro).</p></li>
<li><p>Altere o código do passo 4 para que verifique também o conteúdo das tabelas <code>paths</code> e <code>path_enzyme</code>.</p></li>
</ol>
<h1 id="module7">Módulo 7 – Inserção de dados CSV</h1>
<h2 id="objetivos-7">Objetivos:</h2>
<ul>
<li>Copiar dados de CSV para a base de dados</li>
<li>Consultar os dados com critérios de seleção complexos</li>
</ul>
<h2 id="input-6">Input:</h2>
<ul>
<li>Ficheiro: <a href="files/metabolic_pathways.csv">metabolic_pathways.csv</a>
<ul>
<li>criado no módulo 1</li>
</ul></li>
<li>Ficheiro: <a href="files/all_sequences.csv">all_sequences.csv</a>
<ul>
<li>semelhante ao ficheiro <code>sequences.csv</code> do módulo 3, mas com a sequências de todas as enzimas. Veja a questão 2 da secção <strong>Após a aula</strong> do módulo 3.</li>
</ul></li>
<li>Ficheiro: <a href="files/pathways.db">pathways.db</a>
<ul>
<li>criado no módulo 6</li>
</ul></li>
</ul>
<h2 id="output-6">Output:</h2>
<ul>
<li>Ficheiro: <code>results_1.csv</code></li>
<li>Ficheiro: <code>results_2.csv</code></li>
<li>Ficheiro: <code>results_3.csv</code></li>
<li>Ficheiro: <code>results_4.csv</code></li>
</ul>
<h2 id="passos-7">Passos:</h2>
<ol type="1">
<li><p>Crie um novo <em>script</em> Python <code>module7.py</code> que abre a base de dados criada no módulo anterior e remove as linhas das tabelas.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> sqlite3

connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;pathways.db&#39;</span>)

<span class="co"># Remove todos os dados inseridos nas tabelas</span>
connection.execute(<span class="st">&#39;DELETE FROM path_enzyme&#39;</span>)
connection.execute(<span class="st">&#39;DELETE FROM path&#39;</span>)
connection.execute(<span class="st">&#39;DELETE FROM enzyme&#39;</span>)

<span class="co"># Grava a base de dados</span>
connection.commit()</code></pre></div></li>
<li><p>Adicione o código seguinte ao <em>script</em>, o qual lê os dados de cada via metabólica e adicionam-nos à base de dados.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> csv

<span class="co"># Le as vias selecionadas no modulo 3</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;metabolic_pathways.csv&#39;</span>)
paths <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

<span class="co"># Para cada via, insere a sua informacao na base de dados</span>
<span class="cf">for</span> path <span class="op">in</span> paths:
    <span class="co"># Extrai a informacao da via presente na variavel `path`</span>
    path_id <span class="op">=</span> path[<span class="dv">0</span>]
    path_name <span class="op">=</span> ???
    path_class <span class="op">=</span> ???

    <span class="co"># Insere a informacao na base de dados</span>
    <span class="co"># Note que usamos um comando generico usando a notacao `?`</span>
    <span class="co"># e fornecemos os parametros atraves de um tuplo</span>
    connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">        INSERT INTO path (id, name, class)</span>
<span class="st">        VALUES (?, ?, ?)</span>
<span class="st">    &#39;&#39;&#39;</span>, (path_id, path_name, path_class))

<span class="co"># Grava</span>
connection.commit()</code></pre></div></li>
<li><p>Vamos fazer o mesmo com as enzimas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Agora fazemos o mesmo para as enzimas</span>
f <span class="op">=</span> <span class="bu">open</span>(<span class="st">&#39;all_sequences.csv&#39;</span>)
enzymes <span class="op">=</span> csv.reader(f, delimiter<span class="op">=</span>???)

enzymes_inserted <span class="op">=</span> [] <span class="co"># Lista com as enzimas ja inseridas</span>

<span class="cf">for</span> enzyme <span class="op">in</span> enzymes:
    enzyme_id <span class="op">=</span> ???
    enzyme_sequence <span class="op">=</span> ???

    <span class="co"># Determina se a enzima ja foi inserida anteriormente</span>
    <span class="cf">if</span> enzyme_id <span class="op">not</span> <span class="op">in</span> enzymes_inserted:
        connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">            INSERT INTO enzyme (id, sequence)</span>
<span class="st">            VALUES (?, ?)</span>
<span class="st">        &#39;&#39;&#39;</span>, (enzyme_id, enzyme_sequence))

        <span class="co"># Adiciona esta enzima a lista de enzimas ja inseridas</span>
        enzymes_inserted.append(enzyme_id)

<span class="co"># Grava</span>
connection.commit()</code></pre></div></li>
<li><p>E agora vamos inserir na base de dados a informação que associa cada via às suas enzimas:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Que ficheiro precisamos de ler para relacionar vias e enzimas?</span>
f <span class="op">=</span> <span class="bu">open</span>(???)

paths <span class="op">=</span>  csv.reader(f, delimiter<span class="op">=</span>???)

<span class="cf">for</span> path <span class="op">in</span> paths:
    path_id <span class="op">=</span> path[<span class="dv">0</span>]
    enzyme_list <span class="op">=</span> path[<span class="dv">3</span>].split(<span class="st">&#39;|&#39;</span>)

    <span class="co"># Para cada enzima, precisamos de inserir uma linha</span>
    <span class="co"># na tabela `path_enzyme`</span>
    <span class="cf">for</span> enzyme_id <span class="op">in</span> enzyme_list:
        connection.execute(<span class="st">&#39;&#39;&#39;</span>
<span class="st">            INSERT INTO path_enzyme (path_id, enzyme_id)</span>
<span class="st">            VALUES (?, ?)</span>
<span class="st">        &#39;&#39;&#39;</span>, (path_id, enzyme_id))

connection.commit()</code></pre></div></li>
<li><p>Com um comando SQL, consulte os dados das vias metabólicas e imprima o identificador e o nome no terminal:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT ??? FROM ???&#39;</span>)

<span class="co"># Para cada via, imprime o identificador e o nome</span>
<span class="cf">for</span> row <span class="op">in</span> rows:
    path_id <span class="op">=</span> row[???]
    path_name <span class="op">=</span> row[???]

    <span class="bu">print</span> <span class="st">&#39;Path &#39;</span> <span class="op">+</span> path_id <span class="op">+</span> <span class="st">&#39; is named &quot;&#39;</span> <span class="op">+</span> path_name <span class="op">+</span> <span class="st">&#39;&quot;&#39;</span></code></pre></div></li>
<li><p>Verifique que o output é</p>
<pre class="text"><code>Path hsa00010 is named &quot;Glycolysis / Gluconeogenesis&quot;
Path hsa00020 is named &quot;Citrate cycle (TCA cycle)&quot;
Path hsa00030 is named &quot;Pentose phosphate pathway&quot;
Path hsa00040 is named &quot;Pentose and glucuronate interconversions&quot;
Path hsa00051 is named &quot;Fructose and mannose metabolism&quot;
...</code></pre></li>
<li><p>O código anterior imprime a informação no terminal. Agora queremos gravar essa mesma informação no ficheiro CSV <code>results_1.csv</code>. Substitua o código do passo 5 por isto:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Abre o ficheiro `results_1.csv` em modo de escrita (write mode)</span>
f <span class="op">=</span> <span class="bu">open</span>(???, ???)
w <span class="op">=</span> csv.writer(f, delimiter<span class="op">=</span>???)

rows <span class="op">=</span> connection.execute(<span class="st">&#39;SELECT ??? FROM ???&#39;</span>)

<span class="co"># Escreve a informacao de cada via no ficheiro CSV</span>
<span class="cf">for</span> row <span class="op">in</span> rows:
    w.writerow(row)

f.close()</code></pre></div></li>
<li><p>Selecione agora as enzimas cujo identificador começa com Q e grave-as no ficheiro <code>results_2.csv</code>. A receita é a mesma, apenas mudando o nome do ficheiro e o comando de consulta. Pode usar a seguinte consulta, substituindo onde for apropriado:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ??? <span class="kw">FROM</span> enzyme <span class="kw">WHERE</span> ??? <span class="kw">LIKE</span> <span class="ot">&quot;Q%&quot;</span></code></pre></div></li>
<li><p>Agora vamos cruzar informação de várias tabelas. Duplique e adapte o código do passo anterior, usando o seguinte comando SQL para selecionar as sequências das enzimas de cada via metabólica, e grave o resultado no ficheiro <code>results_3.csv</code>:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> path.name, enzyme.???
<span class="kw">FROM</span> path, enzyme, path_enzyme
<span class="kw">WHERE</span> path.id = path_enzyme.path_id
  <span class="kw">AND</span> enzyme.id = path_enzyme.enzyme_id</code></pre></div></li>
<li><p>SQL permite consultas mais complexas. Use a consulta seguinte para gravar o identificador e o nome das vias metabólicas associadas a pelo menos 300 enzimas. Grave o resultado no ficheiro <code>results_4.csv</code>.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> path.id, path.name
<span class="kw">FROM</span> path, path_enzyme
<span class="kw">WHERE</span> path.id = path_enzyme.path_id
<span class="kw">GROUP</span> <span class="kw">BY</span> path_id <span class="kw">HAVING</span> <span class="fu">COUNT</span>(*) &gt;= <span class="dv">300</span></code></pre></div></li>
</ol>
<h2 id="após-a-aula-6">Após a aula:</h2>
<ol type="1">
<li><p>Determine a razão para usar uma lista <code>enzymes_inserted</code> no passo 3.<br> <strong>Dica</strong>: tente remover o uso da lista, execute o <em>script</em> e observe que o código falha com uma exceção <code>constraint failed</code>.</p></li>
<li><p>Muitos dos passos deste módulo consistem em código repetido.</p>
<ol type="a">
<li><p>Crie uma função <code>run_sql</code> que aceita dois argumentos: um comando SQL e o nome de um ficheiro.</p></li>
<li><p>A implementação desta função deve executar o comando SQL fornecido e gravar o resultado obtido num ficheiro CSV.</p></li>
<li><p>Altere o código deste módulo de forma a que use a função <code>run_sql</code> em vez de repetir código.<br> <strong>Dica</strong>: Os passos 7 a 10 serão simplesmente a chamada à função.</p></li>
</ol></li>
</ol>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script>

// Replace all instances of "???" inside <code> elements with the HTML code:
// <span class="blank">?</span>
$("code").html(function () {
    return $(this).html().replace(/\?\?\?/g, "<span class=\"blank\">?</span>");
});

// "print" is a builtin in python3 but a keyworkd in python2.
// Let's make sure this change happens
$("span.bu").each(function() {
    if ($(this).text() == "print") {
        $(this).removeClass('bu');
        $(this).addClass('kw');
    }
})

</script>
</body>
</html>
